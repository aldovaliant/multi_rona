<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/reminder.css" />

    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
    <style>
      .laporan-penjualan .search {
        margin-left: -3px;
        padding-top: 3px;
        padding-bottom: 3px;
        padding-left: 8px;
        padding-right: 8px;
      }
      .laporan-penjualan table {
        text-align: center;
      }
      .btn-aksi {
        margin-left: 5px;
        margin-right: 5px;
      }
      hr {
        border: 2px solid;
      }
      #detail-diskon,
      #detail-subtotal {
        font-weight: bolder;
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a class="active" href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a href="pengguna.html" style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Laporan</h2>
        <hr />
      </div>

      <div class="container laporan-penjualan">
        <h3>
          Laporan Penjualan
          <button
            class="btn btn-primary"
            style="display: inline-block"
            onclick="window.location = window.location"
          >
            Refresh
          </button>
        </h3>

        <div>
          <label for="tanggal-mulai">Mulai : </label>
          <input
            type="date"
            name="tanggal-mulai"
            id="tanggal-mulai"
            style="width: 150px"
            value="2020-11-01"
          />&ensp;
          <label for="tanggal-sampai">Sampai : </label>
          <input
            type="date"
            name="tanggal-sampai"
            id="tanggal-sampai"
            style="width: 150px"
          />
          <button
            class="btn btn-primary"
            style="margin-right: 20px"
            onclick="setTanggal(false)"
          >
            Set Tanggal
          </button>
          <input
            type="text"
            id="search-input"
            placeholder="Search.."
            name="search"
            style="width: 200px"
          />
          <button
            class="btn btn-outline-secondary search"
            style="margin-right: 20px"
            onclick="search()"
          >
            <i class="fa fa-search"></i>
          </button>
        </div>

        <div>
          <table id="laporan-penjualan">
            <colgroup>
              <col span="1" style="width: 5%" />
              <col span="1" style="width: 15%" />
              <col span="1" style="width: 10%" />
              <col span="1" style="width: 30%" />
              <col span="1" style="width: 15%" />
              <col span="1" style="width: 25%" />
            </colgroup>
            <thead>
              <tr>
                <th>No.</th>
                <th>Tanggal</th>
                <th>No. Transaksi</th>
                <th>Pelanggan</th>
                <th>Subtotal</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tbody-penjualan"></tbody>
          </table>
          <h5 style="float: right;" id="kalkulasi">Total Kalkulasi : </h5>
        </div>
      </div>

      <!-- MODAL DETAIL PENJUALAN -->
      <div class="modal" id="modalDetailPenjualan">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title" id="title-detail">Detail Penjualan</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
              <table>
                <colgroup>
                  <col span="1" style="width: 5%" />
                  <col span="1" style="width: 25%" />
                  <col span="1" style="width: 20%" />
                  <col span="1" style="width: 10%" />
                  <col span="1" style="width: 15%" />
                  <col span="1" style="width: 25%" />
                </colgroup>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Produk</th>
                    <th>Harga Per Jumlah</th>
                    <th>Jumlah</th>
                    <th>Diskon</th>
                    <th>Total Harga</th>
                  </tr>
                </thead>
                <tbody id="table-detail" class="table-detail"></tbody>
              </table>
              <div style="padding-top: 5%; float: right">
                <p id="detail-subtotal" style="float: right">Subtotal :</p>
                <br />
                <p id="detail-bayar" style="float: right">Uang Bayar :</p>
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL HAPUS PRODUK -->
      <div class="modal" id="modalHapusPenjualan">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Hapus Penjualan</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
              <p id="hapus-nama"></p>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="button"
                class="btn btn-danger"
                data-dismiss="modal"
                onclick="hapusPenjualan()"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script>
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = sessionStorage.getItem("baseUrl");
      // var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // var baseUrl = "http://localhost/multi_rona/";
      // if (sessionStorage.getItem("online_db") == true)
      //   baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // else baseUrl = "http://localhost/multi_rona/";
      var curId = null;
      var arrPenjualan = [];
      var rowsPenjualan = [];
      var tglMulai = "",
        tglSampai = "";
      window.onload = setTanggal(true);
      window.onload = getPenjualan(0);

      function setTanggal(awal) {
        if (awal) {
          let date = new Date();
          let year = date.getFullYear();
          let month = "" + (date.getMonth() + 1);
          let day = "" + date.getDate();
          if (month.length < 2) month = "0" + month;
          if (day.length < 2) day = "0" + day;
          tglMulai = year + "-" + month + "-01";
          tglSampai = year + "-" + month + "-" + day;
          $("#tanggal-mulai").val(tglMulai);
          $("#tanggal-sampai").val(tglSampai);
        } else {
          tglMulai = $("#tanggal-mulai").val();
          tglSampai = $("#tanggal-sampai").val();
          getPenjualan(1);
        }
      }

      function getPenjualan(param) {
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/laporan/penjualan?tglMulai=" +
        //   tglMulai +
        //   "&tglSampai=" +
        //   tglSampai;
        let url =
          baseUrl +
          "laporan/penjualan?tglMulai=" +
          tglMulai +
          "&tglSampai=" +
          tglSampai;
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrPenjualan = data;
            createTable(param);
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function createTable(param) {
        let kalkulasi = 0;
        let tbody = document.getElementsByTagName("tbody");
        $("#laporan-penjualan > tbody").empty();
        for (let i = 0, k = 1; i < arrPenjualan.length; i++, k++) {
          let btnDetail = document.createElement("button");
          btnDetail.appendChild(document.createTextNode("detail"));
          btnDetail.className = "btn btn-secondary btn-aksi btn-detail";
          btnDetail.onclick = function () {
            getDetail(this);
          };

          let tr = document.createElement("tr");
          let td = document.createElement("td");
          td.textContent = k;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrPenjualan[i].tanggal;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrPenjualan[i].no_transaksi;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrPenjualan[i].nama;
          tr.appendChild(td);
          td = document.createElement("td");
          td.className = "rupiah";
          td.textContent = rupiahFormat(arrPenjualan[i].total_penjualan);
          kalkulasi += parseInt(arrPenjualan[i].total_penjualan);
          tr.appendChild(td);
          td = document.createElement("td");
          td.appendChild(btnDetail);
          tr.appendChild(td);

          tbody[0].appendChild(tr);
          rowsPenjualan.push(tr);
        }
        $(".btn-detail").attr("data-toggle", "modal");
        $(".btn-detail").attr("data-target", "#modalDetailPenjualan");
        $(".rupiah").css("text-align", "right");
        $("#kalkulasi").text('Total Kalkulasi : ' + rupiahFormat(kalkulasi));
        resetExport();
      }
      
      $("#modalDetailPenjualan").on("hidden.bs.modal", function (e) {
        clearInput("detail");
      });

      function getDetail(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPenjualan[x].no_transaksi;
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/laporan/penjualan_detail?id=" +
        //   id;
        let url = baseUrl + "laporan/penjualan_detail?id=" + id;
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            let tbody = document.getElementById("table-detail");
            let diskon = 0;
            for (let i = 0; i < data.length; i++) {
              let tr = document.createElement("tr");
              let td = document.createElement("td");
              td.textContent = i + 1;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = data[i].nama;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = rupiahFormat(data[i].harga_satuan);
              td.style.textAlign = "right";
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = data[i].jumlah;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = data[i].diskon;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = rupiahFormat(data[i].total_harga);
              td.style.textAlign = "right";
              tr.appendChild(td);

              tbody.appendChild(tr);
            }
            let subtotal = param.parentNode.parentNode.childNodes[4].innerHTML;
            document.getElementById("detail-subtotal").innerHTML =
              "Subtotal : " + subtotal;
            document.getElementById("detail-bayar").innerHTML =
              "Uang Bayar : " + rupiahFormat(data[0].total_pembayaran);
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function clearInput(param) {
        $("#table-detail").empty();
        document.getElementById("detail-diskon").innerHTML = "";
        document.getElementById("detail-subtotal").innerHTML = "";
        $(".tableexport-caption").css("display", "revert");
      }

      $(document).ready(function () {
        $("#search-input").on("keyup", function () {
          var value = $(this).val().toLowerCase();
          $("#tbody-penjualan tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
          });
        });
      });
      function search() {
        let searchInput = $("#search-input").val();
        let tbody = $("#laporan-penjualan > tbody");
        if (searchInput == "") {
          tbody.empty();
          getPenjualan();
        }
        let rowsResult = [];
        let tr = tbody.children();
        console.log(arrPenjualan);
        for (let i = 0; i < arrPenjualan.length; i++) {
          let td = arrPenjualan[i];
          if (
            searchInput == arrPenjualan[i].no_transaksi ||
            searchInput == arrPenjualan[i].tanggal ||
            searchInput == arrPenjualan[i].nama ||
            searchInput == arrPenjualan[i].total_penjualan
          ) {
            rowsResult.push(rowsPenjualan[i]);
          }
        }
        tbody.empty();
        for (let k = 0; k < rowsResult.length; k++) {
          tbody.append(rowsResult[k]);
        }
      }

      function previewHapus(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPenjualan[x].no_transaksi;
        curId = id;
        $("#hapus-nama").text(
          "Apakah anda yakin ingin menghapus penjualan no. transaksi " +
            arrPenjualan[x].no_transaksi +
            "?"
        );
      }

      function hapusPenjualan() {
        let paramId = {
          id: curId,
        };
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/laporan/hapus_penjualan";
        let url = baseUrl + "laporan/hapus_penjualan";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(paramId),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            dialogs.alert(data.message, (ok) => {
              window.location = window.location;
            });
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function rupiahFormat(bilangan) {
        let number_string = bilangan.toString(),
          sisa = number_string.length % 3,
          rupiah = number_string.substr(0, sisa),
          ribuan = number_string.substr(sisa).match(/\d{3}/g);

        if (ribuan) {
          separator = sisa ? "." : "";
          rupiah += separator + ribuan.join(".");
        }
        return rupiah;
      }

      var Table = document.getElementById("laporan-penjualan");
      var exportTable = require("tableexport");
      var instance = exportTable(Table, {
        headers: true, // (Boolean), display table headers (th or td elements) in the <thead>, (default: true)
        footers: true, // (Boolean), display table footers (th or td elements) in the <tfoot>, (default: false)
        formats: ["xlsx", "csv", "txt"], // (String[]), filetype(s) for the export, (default: ['xlsx', 'csv', 'txt'])
        filename: "id", // (id, String), filename for the downloaded file, (default: 'id')
        bootstrap: false, // (Boolean), style buttons using bootstrap, (default: true)
        exportButtons: true, // (Boolean), automatically generate the built-in export buttons for each of the specified formats (default: true)
        position: "top", // (top, bottom), position of the caption element relative to table, (default: 'bottom')
        ignoreRows: null, // (Number, Number[]), row indices to exclude from the exported file(s) (default: null)
        ignoreCols: [0, 5], // (Number, Number[]), column indices to exclude from the exported file(s) (default: null)
        trimWhitespace: false, // (Boolean), remove all leading/trailing newlines, spaces, and tabs from cell text in the exported file(s) (default: false)
        RTL: false, // (Boolean), set direction of the worksheet to right-to-left (default: false)
        sheetname: "id", // (id, String), sheet name for the exported spreadsheet, (default: 'id')
      });
      $(".button-default").addClass("btn btn-secondary");
      var resetButton = document.getElementById("reset");
      function resetExport() {
        var formatHarga = document.getElementsByClassName("rupiah");
        for (let i = 0; i < formatHarga.length; i++) {
          formatHarga[i].innerHTML = formatHarga[i].innerHTML.replace(
            /[.]/g,
            ""
          );
        }
        instance.reset();
        for (let i = 0; i < formatHarga.length; i++) {
          formatHarga[i].innerHTML = rupiahFormat(formatHarga[i].innerHTML);
        }
        $(".button-default").addClass("btn btn-outline-secondary");
        $(".button-default").css("margin-right", "5px");
      }
    </script>
  </body>
</html>
