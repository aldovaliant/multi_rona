<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/reminder.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
    <style>
      hr {
        border: 2px solid;
      }
      .inventaris-masuk label {
        margin-top: 10px;
      }
      .inventaris-masuk select,
      input {
        width: 250px;
        padding: 3px;
      }
      #form input,
      select {
        width: 15%;
        margin-right: 5px;
      }
      table {
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="active dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a class="active" href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a href="pengguna.html" style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Inventaris</h2>
        <hr />
      </div>

      <div class="container inventaris-masuk">
        <h3>
          Tambah Stok &emsp;<button class="btn btn-primary" onclick="refresh()">
            Refresh
          </button>
        </h3>
        <label for="barang">Pilih Produk &ensp;&emsp; &ensp; : &emsp;</label>
        <select name="produk" id="produk"></select
        ><br />

        <label for="satuan"
          >Satuan &ensp;&emsp;&emsp;&emsp; &ensp; :&emsp;</label
        >
        <input type="text" name="satuan" id="satuan" disabled /><br />

        <label for="stok">Stok Sekarang &ensp;&ensp; :&emsp;</label>
        <input type="number" name="stok" id="stok" disabled /><br />

        <label for="konversi">Jumlah Konversi :&emsp;</label>
        <input type="text" name="konversi" id="konversi" disabled /><br />

        <label for="sisa-ecer"
          >Sisa Ecer &emsp;&emsp;&emsp;&ensp; :&emsp;</label
        >
        <input type="text" name="sisa-ecer" id="sisa-ecer" disabled /><br />

        <label for="jumlah">Jumlah Tambah :&emsp;</label>
        <input type="number" name="jumlah" id="jumlah" min="1" /><br />

        <label for="supplier"
          >Supplier &ensp;&emsp;&emsp;&emsp; &ensp;:&emsp;</label
        >
        <input type="text" name="supplier" id="supplier" disabled />
        <br />

        <div id="form"></div>
        <div class="container" style="display: none">
          <h4>Pratinjau</h4>
          <table id="tabel-preview">
            <colgroup>
              <col span="1" style="width: 20%" />
              <col span="1" style="width: 20%" />
              <col span="1" style="width: 20%" />
              <col span="1" style="width: 20%" />
              <col span="1" style="width: 20%" />
            </colgroup>
            <thead>
              <tr>
                <th>Jenis Stok</th>
                <th>Jumlah Stok</th>
                <th>Satuan</th>
                <th>Konversi Per Satuan</th>
                <th>Stok Konversi</th>
              </tr>
            </thead>
            <tbody id="tbody-preview"></tbody>
          </table>
          <div style="float: right">
            <label for="hasil-utama">Jumlah Akhir Stok Utama&emsp;: </label>
            <input
              type="number"
              name="hasil-utama"
              id="hasil-utama"
              disabled
            /><br />
            <label for="hasil-konversi">Jumlah Akhir Stok Konversi : </label>
            <input
              type="number"
              name="hasil-konversi"
              id="hasil-konversi"
              disabled
            /><br />
            <label for="hasil-ecer"
              >Jumlah Akhir Sisa Ecer &emsp;&emsp;:
            </label>
            <input
              type="number"
              name="hasil-ecer"
              id="hasil-ecer"
              disabled
            /><br />
            <div style="float: right">
            </div>
          </div>
        </div>

        <div style="margin-top: 10px">
          <button
            class="btn btn-primary"
            onclick="preview()"
            data-toggle="modal"
            data-target="#modalPreview"
          >
            TAMBAH
          </button>
        </div>
      </div>
    </div>

    <!-- The Modal -->
    <div class="modal" id="modalPreview">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Preview Tambah Stok</h4>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>

          <!-- Modal body -->
          <div class="modal-body">
            <!-- <h5>Satuan Utama</h5> -->
            <div class="row">
              <div class="col">
                <p>Nama Produk &emsp;&emsp;:</p>
                <!-- <p>Jumlah Tambah &nbsp;:</p> -->
                <!-- <p>Konversi Awal&emsp;&ensp; :</p>
                <p>Konversi Akhir &emsp;&ensp;:</p> -->
              </div>
              <div class="col-8">
                <p class="preview"></p>
                <!-- <input class="input-preview" disabled /> -->
                <!-- <input class="input-preview" disabled />
                <input class="input-preview" disabled /> -->
              </div>
            </div>
            <!-- <h5 id="ecer-judul" style="display: none">Satuan Eceran</h5> -->
            <table id="preview-tbl" style="display: none">
              <thead>
                <tr>
                  <!-- <th>Satuan Eceran</th>
                  <th>Jumlah Tambah</th>
                  <th>Jumlah Konversi</th> -->
                  <th>Jenis Stok</th>
                  <th>Satuan</th>
                  <th>Jumlah Stok</th>
                  <th>Konversi Per Satuan</th>
                  <th>Stok Konversi</th>
                </tr>
              </thead>
              <tbody id="preview-tbody"></tbody>
            </table>
            <div>
              <label for="preview-stok"
                >Jumlah Akhir Stok Utama &ensp; :
              </label>
              <input
                type="number"
                name="preview-stok"
                id="preview-stok"
                disabled
              /><br />
              <label for="preview-konversi"
                >Jumlah Akhir Stok Konversi :
              </label>
              <input
                type="number"
                name="preview-konversi"
                id="preview-konversi"
                disabled
              /><br />
              <label for="preview-ecer"
                >Jumlah Akhir Sisa Ecer &emsp;&emsp;:
              </label>
              <input
                type="text"
                name="preview-ecer"
                id="preview-ecer"
                disabled
              />
            </div>
          </div>

          <!-- Modal footer -->
          <div class="modal-footer">
            <h5>Apakah data ini sudah benar?</h5>
            <br />
            <button
              type="button"
              class="btn btn-danger"
              data-dismiss="modal"
              onclick="clearModal()"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              data-dismiss="modal"
              id="edit-btn"
              onclick="insertStok()"
            >
              Tambah
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script>
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      var arrProduk = [];
      var arrEcer = [];
      var arrSupplier = [];
      var is_eceran = false;
      var idSatuan = 0;
      var curJmlKonversi = 0;
      var curStokUtama = 0;
      var arrIdxEcer = [];
      var arrSatuan = [];
      var curIdProduk = 0,
        curIdSatuan = 0,
        curIdEcer = 0;
      var satuanKonversi;
      var hasilKonversi, hasilSisaEcer, totalKonversi;
      var arrToken = [];
      window.onload = getProduk();
      window.onload = getAndroidToken();
      dropdown = document.getElementsByClassName("dropdown-container");
      dropdown[0].addEventListener("click", function () {
        this.classList.toggle("active");
      });

      function getProduk() {
        let url = baseUrl + "inventaris/pilih_produk";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrProduk = data;
            let select = document.getElementById("produk");
            for (let i = 0; i < data.length; i++) {
              let opt = document.createElement("option");
              opt.innerHTML = data[i].nama;
              opt.value = data[i].nama;
              select.appendChild(opt);
            }
            curJmlKonversi = arrProduk[0].jumlah_konversi;
            $("#supplier").val(arrProduk[0].nama_supplier);
            getSatuan(data[0].id);
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function createTablePreview(
        jumlah,
        konversiSatuan,
        jmlKonversi,
        sisaEcer
      ) {
        let tbody = $("#tabel-preview > tbody");
        let tr = document.createElement("tr");
        tr.id = "stok-utama";
        let td = document.createElement("td");
        td.textContent = "Stok Sekarang";
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[curId].jumlah;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[curId].nama_satuan;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = konversiSatuan;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = jmlKonversi;
        tr.appendChild(td);

        tbody.append(tr);

        if (is_eceran) {
          tr = document.createElement("tr");
          tr.id = "stok-ecer";
          td = document.createElement("td");
          td.textContent = "Sisa Ecer";
          tr.appendChild(td);
          td = document.createElement("td");
          if (sisaEcer != 0) td.textContent = "Ada";
          else td.textContent = "Tidak ada";
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrSatuan[curId].nama_satuan;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = konversiSatuan;
          tr.appendChild(td);
          td = document.createElement("td");
          if (sisaEcer != 0) td.textContent = sisaEcer;
          else td.textContent = 0;
          tr.appendChild(td);
          tbody.append(tr);
        }
      }

      function getSatuan(id) {
        let url = baseUrl + "inventaris/satuan?id=" + id;
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrSatuan = data;
            document.getElementById("satuan").value = data[0].nama_satuan;
            document.getElementById("stok").value = data[0].jumlah;
            $("#konversi").val(data[0].jumlah_konversi);
            if (data[0].sisa_ecer != null) {
              $("#sisa-ecer").val(data[0].sisa_ecer);
              hasilSisaEcer = parseFloat(data[0].sisa_ecer);
            } else {
              hasilSisaEcer = 0;
            }
            hasilKonversi = parseFloat(data[0].jumlah_konversi);
            totalKonversi = hasilKonversi + hasilSisaEcer;
            curStokUtama = data[0].jumlah;
            idSatuan = data[0].id;
            satuanKonversi = parseFloat(data[0].konversi_satuan);
            is_eceran = false;
            if (data[0].is_eceran == 1) {
              arrEcer = data[0].ecer;
              is_eceran = true;
              listEcer(data);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function listEcer(data) {
        let br = document.createElement("br");
        let div = document.getElementById("form");
        let h5 = document.createElement("h5");
        let p = document.createElement("p");
        h5.innerHTML = "Tambah Stok Eceran";
        p.innerHTML =
          "(Beri centang pada satuan eceran yang ingin ditambah jumlah stoknya)";
        div.appendChild(br);
        div.appendChild(h5);
        div.appendChild(p);
        for (let i = 0; i < arrEcer.length; i++) {
          let check = document.createElement("input");
          check.className = "list-check";
          check.type = "checkbox";
          check.style.width = "10%";
          div.appendChild(check);

          let label = document.createElement("label");
          label.htmlFor = "tambah-satuan-ecer";
          label.textContent = "Satuan Ecer : ";
          div.appendChild(label);
          let input = document.createElement("input");
          input.name = "tambah-satuan-ecer";
          input.className = "list-satuan";
          input.value = arrEcer[i].nama_satuan;
          input.disabled = true;
          input.style.width = "10%";
          div.appendChild(input);

          label = document.createElement("label");
          label.htmlFor = "tambah-jumlah-ecer";
          label.textContent = "Jumlah Tambah : ";
          div.appendChild(label);
          input = document.createElement("input");
          input.name = "tambah-jumlah-ecer";
          input.className = "list-stok";
          input.value = 0;
          input.min = 0;
          input.oninput = function () {
            this.value = Math.abs(this.value);
          };
          input.type = "number";
          input.style.width = "10%";
          div.appendChild(input);

          label = document.createElement("label");
          label.htmlFor = "tambah-konversi-satuan";
          label.textContent = "Konversi Satuan : ";
          div.appendChild(label);
          input = document.createElement("input");
          input.name = "tambah-konversi-satuan";
          input.className = "list-konversi-satuan";
          let konversiSatuan = arrEcer[i].konversi_satuan;
          input.value = konversiSatuan;
          input.type = "number";
          input.style.width = "10%";
          input.disabled = true;
          div.appendChild(input);

          label = document.createElement("label");
          label.htmlFor = "tambah-jumlah-konversi";
          label.textContent = "Jumlah Konversi : ";
          div.appendChild(label);
          input = document.createElement("input");
          input.name = "tambah-jumlah-konversi";
          input.className = "list-jumlah-konversi";
          input.value =
            parseFloat(konversiSatuan) *
            parseFloat(document.getElementsByClassName("list-stok")[i].value);

          input.type = "number";
          input.style.width = "10%";
          input.disabled = true;

          $(".list-stok")[i].addEventListener("input", function () {
            let jmlKonversi =
              parseFloat($(".list-konversi-satuan")[i].value) *
              $(".list-stok")[i].value;
            jmlKonversi = jmlKonversi.toFixed(2);
            $(".list-jumlah-konversi")[i].value = jmlKonversi;
          });

          div.appendChild(input);
        }
      }

      function addEcer(param, i) {
        if (param.checked) {
          if ($("#add-ecer-" + i).length == 0) {
            let tbody = $("#tbody-preview");
            let tr = document.createElement("tr");
            tr.id = "add-ecer-" + i;
            tr.style.color = "red";
            let td = document.createElement("td");
            td.textContent = "Tambah Stok Ecer";
            tr.appendChild(td);
            td = document.createElement("td");
            td.textContent = $(".list-stok")[i].value;
            tr.appendChild(td);
            td = document.createElement("td");
            td.textContent = arrEcer[i].nama_satuan;
            tr.appendChild(td);
            td = document.createElement("td");
            td.textContent = arrEcer[i].konversi_satuan;
            tr.appendChild(td);
            td = document.createElement("td");
            td.textContent = "-" + $(".list-jumlah-konversi")[i].value;
            tr.appendChild(td);
            tbody.append(tr);
          } else {
            $("#add-ecer-" + i)
              .children()
              .eq(1)
              .text($(".list-stok")[i].value);
            $("#add-ecer-" + i)
              .children()
              .eq(4)
              .text("-" + $(".list-jumlah-konversi")[i].value);
          }
          let ecerKonversi = parseFloat($(".list-jumlah-konversi")[i].value);
          let sisaEcer = parseFloat($("#sisa-ecer").val());
          let totalKurangEcer = totalKonversi - ecerKonversi;
          let hasilUtama = Math.floor(
            totalKurangEcer / parseFloat(arrSatuan[0].konversi_satuan)
          );
          let konversiHasil =
            hasilUtama * parseFloat(arrSatuan[0].konversi_satuan);
          let hasilEcer = totalKurangEcer - konversiHasil;
          $("#hasil-utama").val(hasilUtama);
          $("#hasil-konversi").val(konversiHasil);
          $("#hasil-ecer").val(hasilEcer);
        } else {
          $("#add-ecer-" + i).remove();
        }
      }

      function hitungStokAkhir(tambah, bilangan) {
        let res;
        if (tambah) {
          res = parseInt($("#hasil-utama").val()) + parseInt(bilangan);
        } else {
          res = parseInt($("#hasil-utama").val()) - parseInt(bilangan);
        }
        $("#hasil-utama").val(res);
      }

      function getSupplier() {
        let url = baseUrl + "inventaris/supplier";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrSupplier = data;
            let select = document.getElementById("supplier");
            for (let i = 0; i < data.length; i++) {
              let opt = document.createElement("option");
              opt.innerHTML = data[i].nama;
              opt.value = data[i].nama;
              select.appendChild(opt);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      document.getElementById("produk").oninput = function () {
        document.getElementById("jumlah").value = "";
        let idxProduk = document.getElementById("produk").selectedIndex;
        curIdProduk = idxProduk;
        $("#supplier").val(arrProduk[idxProduk].nama_supplier);
        curJmlKonversi = arrProduk[idxProduk].jumlah_konversi;
        $("#konversi").val(curJmlKonversi);
        const myNode = document.getElementById("form");
        while (myNode.firstChild) {
          myNode.removeChild(myNode.lastChild);
        }
        getSatuan(arrProduk[idxProduk].id);
        if (arrProduk[idxProduk].is_eceran == 0) {
          $("#sisa-ecer").val("Bukan Produk Eceran");
        }
        $("#tabel-preview > tbody").empty();
      };

      $("#modalPreview").on("hidden.bs.modal", function (e) {
        clearModal();
      });

      function clearModal() {
        let preview = document.getElementsByClassName("preview");
        for (let i = 0; i < preview.length; i++) {
          preview[i].innerHTML = "";
        }
        let parent = document.getElementById("preview-tbody");
        while (parent.hasChildNodes()) {
          parent.removeChild(parent.firstChild);
        }
      }

      function preview() {
        let tbody = document.getElementById("preview-tbody");
        let tr = document.createElement("tr");
        tr.id = "stok-utama";
        let td = document.createElement("td");
        td.textContent = "Stok Sekarang";
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[0].nama_satuan;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[0].jumlah;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[0].konversi_satuan;
        tr.appendChild(td);
        td = document.createElement("td");
        td.textContent = arrSatuan[0].jumlah_konversi;
        tr.appendChild(td);
        tbody.append(tr);
        let check = document.getElementsByClassName("list-check");
        isEceran = false;
        let totalEcer = 0;
        if (check.length > 0) {
          tr = document.createElement("tr");
          tr.id = "stok-ecer";
          td = document.createElement("td");
          td.textContent = "Sisa Ecer";
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrSatuan[0].nama_satuan;
          tr.appendChild(td);
          td = document.createElement("td");
          if (arrSatuan[0].sisa_ecer != 0) td.textContent = "Ada";
          else td.textContent = "Tidak ada";
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrSatuan[0].konversi_satuan;
          tr.appendChild(td);
          td = document.createElement("td");
          if (arrSatuan[0].sisa_ecer != 0)
            td.textContent = arrSatuan[0].sisa_ecer;
          else td.textContent = 0;
          tr.appendChild(td);
          tbody.append(tr);
        }
        let jmlTambahKonversi = 0;
        let tambahUtama = document.getElementById("jumlah");
        if (tambahUtama.value != "" || tambahUtama.value != 0) {
          tr = document.createElement("tr");
          tr.style.color = "blue";
          td = document.createElement("td");
          td.textContent = "Tambah Stok Utama";
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrSatuan[0].nama_satuan;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = tambahUtama.value;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrSatuan[0].konversi_satuan;
          tr.appendChild(td);
          td = document.createElement("td");
          jmlTambahKonversi =
            parseFloat(tambahUtama.value) *
            parseFloat(arrSatuan[0].konversi_satuan);
          td.textContent = "+" + jmlTambahKonversi;
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
        if (check.length > 0) {
          for (let i = 0; i < check.length; i++) {
            if (check[i].checked == true) {
              let ubah = document.getElementsByClassName("list-stok")[i].value;
              if (ubah == "" || ubah == 0) {
                dialogs.alert("Input Tambah Eceran tidak boleh kosong.");
              } else {
                isEceran = true;
                tr = document.createElement("tr");
                tr.style.color = "red";
                td = document.createElement("td");
                td.textContent = "Tambah Stok Ecer";
                tr.appendChild(td);
                td = document.createElement("td");
                td.textContent = arrEcer[i].nama_satuan;
                tr.appendChild(td);
                td = document.createElement("td");
                td.textContent = $(".list-stok")[i].value;
                tr.appendChild(td);
                td = document.createElement("td");
                td.textContent = arrEcer[i].konversi_satuan;
                tr.appendChild(td);
                td = document.createElement("td");
                td.textContent = "-" + $(".list-jumlah-konversi")[i].value;
                tr.appendChild(td);
                tbody.appendChild(tr);
                arrIdxEcer.push(i);
                totalEcer += parseFloat($(".list-jumlah-konversi")[i].value);
              }
            }
          }
        }
        let res = totalKonversi - totalEcer + jmlTambahKonversi;
        if (res < 0) {
          dialogs.alert("Stok tidak mencukupi.", (ok) => {
            window.location = window.location;
          });
        } else {
          let resStok = Math.floor(res / arrSatuan[0].konversi_satuan);
          let resKonversi = resStok * arrSatuan[0].konversi_satuan;
          let resSisa = res - resKonversi;
          let jumlah = document.getElementById("jumlah").value;
          let preview = document.getElementsByClassName("preview");
          preview[0].innerHTML = document.getElementById("produk").value;
          $("#preview-stok").val(resStok);
          $("#preview-konversi").val(resKonversi);
          if (arrProduk[curIdProduk].is_eceran == 1)
            $("#preview-ecer").val(resSisa);
          else $("#preview-ecer").val("Bukan Produk Eceran");
          if (isEceran) {
            document.getElementById("preview-tbl").style.display = "block";
            document.getElementById("edit-btn").style.display = "block";
          } else if (jumlah == "") {
            dialogs.alert("Input jumlah tambah harus diisi.");
            document.getElementById("edit-btn").style.display = "none";
          } else if (jumlah != "") {
            document.getElementById("preview-tbl").style.display = "block";
            document.getElementById("edit-btn").style.display = "block";
          } else {
            document.getElementById("preview-tbl").style.display = "none";
            document.getElementById("edit-btn").style.display = "none";
          }
        }
      }

      function insertStok() {
        let arr = [];
        let listEcer = document.getElementsByClassName("list-check");
        let tbody = $("#preview-tbody");
        for (let i = 0; i < listEcer.length; i++) {
          if (listEcer[i].checked) {
            let obj = {
              id_eceran: arrEcer[i].id_eceran,
              fk_satuan: arrEcer[i].id_satuan,
              jumlah: $(".list-stok")[i].value,
            };
            arr.push(obj);
          }
        }
        let param = {
          fk_produk:
            arrProduk[document.getElementById("produk").selectedIndex].id,
          jumlah: $("#preview-stok").val(),
          jumlah_konversi: $("#preview-konversi").val(),
          fk_user: sessionStorage.getItem("id_user"),
          fk_satuan: idSatuan,
          arr_ecer: arr,
        };
        if (arrProduk[curIdProduk].is_eceran == 1)
          param.sisa_ecer = $("#preview-ecer").val();
        let url = baseUrl + "inventaris/masuk";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
            if (data.status == 200) {
              sendAndroidNotif(data.message);
              insertNotif(data.message);
              dialogs.alert(data.message, (ok) => {
                window.location = window.location;
              });
            }
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal menambahkan transaksi!");
          });
        clearAll();
        curJmlKonversi = 0;
      }

      function getAndroidToken() {
        let url = baseUrl + "android/token";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              arrToken.push(data[i].token);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      //ANDROID PUSH NOTIF
      function sendAndroidNotif(msg) {
        var myHeaders = new Headers();
        myHeaders.append("Content-type", "application/json");
        myHeaders.append(
          "Authorization",
          "key=AAAA50qCXc8:APA91bHjNNL3LH6gCsEVUy4qhO_2wU08w-MQw5zeqcKzNmWuzPXpaDVqfQRgv9B3FKDyEUAtC8RSoT4aWbovrbc5IYi_dzDkOiN-5BUi4wms5_GhJzAdr5piZ6q0mtEUOgvmI9dbJ21U"
        );
        var raw = JSON.stringify({
          registration_ids: arrToken,
          notification: {
            title: "Notif Multi Rona",
            body: msg,
          },
        });
        var requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };
        fetch("https://fcm.googleapis.com/fcm/send", requestOptions)
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.log("error", error));
      }

      //INSERT NOTIFIKASI
      function insertNotif(message) {
        let param = {
          message: message,
        };
        let url = baseUrl + "notifikasi";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
          })
          .catch((error) => console.log("error", error));
      }

      function refresh() {
        window.location = window.location;
      }

      function tambahEceran() {
        if (is_eceran) {
          let form = document.getElementById("form");
          let br = document.createElement("br");
          let select = document.createElement("select");
          select.className = "list-select";
          for (let i = 0; i < arrEcer.length; i++) {
            let opt = document.createElement("option");
            opt.innerHTML = arrEcer[i].nama_satuan;
            opt.value = arrEcer[i].nama_satuan;
            select.appendChild(opt);
          }
          form.appendChild(select);
          let input = document.createElement("input");
          input.type = "number";
          input.name = "jumlah";
          input.className = "list-jumlah";
          input.placeholder = "Jumlah Eceran...";
          input.min = 1;
          form.appendChild(input);
          form.appendChild(input);
          input = document.createElement("button");
          input.textContent = "hapus";
          input.className = "btn btn-danger";
          form.appendChild(input);
          form.appendChild(br);
        } else {
          dialogs.alert("Produk ini tidak mempunyai satuan eceran.");
        }
      }

      function clearAll() {
        document.getElementById("produk").value = "";
        document.getElementById("satuan").value = "";
        document.getElementById("stok").value = "";
        document.getElementById("jumlah").value = "";
        document.getElementById("supplier").value = "";
      }
    </script>
  </body>
</html>
