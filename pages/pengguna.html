<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/reminder.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
  </head>
  <style>
    hr {
      border: 2px solid;
    }
  </style>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn" id="laporan-nav">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a
        class="active"
        href="pengguna.html"
        style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Pengguna</h2>
        <hr />
      </div>
      <div class="container">
        <h3>List Pengguna</h3>
        <button
          class="btn btn-primary"
          style="float: right; margin-right: 10px; margin-bottom: 10px"
          data-toggle="modal"
          data-target="#modalTambahPengguna"
          id="tambah-btn"
        >
          Tambah Pengguna
        </button>

        <table style="text-align: center">
          <colgroup>
            <col span="1" style="width: 5%" />
            <col span="1" style="width: 20%" />
            <col span="1" style="width: 22%" />
            <col span="1" style="width: 23%" />
            <col span="1" style="width: 15%" />
            <col span="1" style="width: 15%" />
          </colgroup>
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Pengguna</th>
              <th>Jenis Pengguna</th>
              <th>Terakhir Login</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- MODAL TAMBAH PELANGGAN -->
      <div class="modal" id="modalTambahPengguna">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Tambah Pengguna</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 20%">
              <div class="row">
                <label for="nama">Nama Pengguna : &emsp;</label>
                <input type="text" name="nama" id="tambah-nama" />
              </div>
              <br />
              <div class="row">
                <label for="jenis">Jenis Pengguna &nbsp;: &emsp;</label>
                <select name="jenis" id="tambah-jenis"></select>
              </div>
              <br />
              <div class="row">
                <label for="alamat">Username &emsp;&emsp;&emsp;: &emsp;</label>
                <input type="text" name="username" id="tambah-username" />
              </div>
              <br />
              <div class="row">
                <label for="telp">Password &emsp; &emsp;&emsp; : &emsp;</label>
                <input type="password" name="password" id="tambah-password" />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Batal
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="insertPengguna()"
              >
                Tambah
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL EDIT PENGGUNA -->
      <div class="modal" id="modalEditPengguna">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Edit Pengguna</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 20%">
              <div class="row">
                <label for="nama">Nama &emsp;&emsp;&emsp;&ensp; : &emsp;</label>
                <input
                  type="text"
                  name="nama"
                  id="edit-nama"
                  style="width: 60%"
                />
              </div>
              <br />
              <div class="row">
                <label for="telp">Username&emsp;&emsp;: &emsp;</label>
                <input
                  type="text"
                  name="telp"
                  id="edit-username"
                  style="width: 60%"
                />
              </div>
              <br />
              <div class="row">
                <label for="alamat">Password &emsp;&emsp;: &emsp;</label>
                <input
                  type="password"
                  name="alamat"
                  id="edit-password"
                  style="width: 60%"
                />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Batal
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="insertEdit()"
              >
                Edit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL HAPUS PENGGUNA -->
      <div class="modal" id="modalHapusPengguna">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Hapus Pengguna</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body w3-display-container" style="padding: 5%">
              <p id="hapus-text"></p>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="button"
                class="btn btn-danger"
                data-dismiss="modal"
                onclick="hapusPengguna()"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script>
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = sessionStorage.getItem("baseUrl");
      // var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // var baseUrl = "http://localhost/multi_rona/";
      // if (sessionStorage.getItem("online_db") == true)
      //   baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // else baseUrl = "http://localhost/multi_rona/";
      var arrPengguna = [];
      var arrJenis = [];
      var curId = "";
      var curEdit = {};
      var arrToken = [];
      window.onload = getPengguna();
      window.onload = getJenisPengguna();
      window.onload = getAndroidToken();
      if (sessionStorage.getItem("jenis_user") != "pemilik") {
        $("#laporan-nav").css("display", "none");
        $("#tambah-btn").css("display","none");
      }

      function getPengguna() {
        let url = baseUrl + "user";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrPengguna = data;
            console.log(data);
            createTable();
          })
          .catch(function (error) {
            console.log(error);
          });
      }
      function getJenisPengguna() {
        let url = baseUrl + "user/jenis";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrJenis = data;
            console.log(data);
            for (let i = 0; i < data.length; i++) {
              let opt = document.createElement("option");
              opt.textContent = data[i].nama;
              opt.value = data[i].id;
              document.getElementById("tambah-jenis").appendChild(opt);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function createTable() {
        let tbody = document.getElementsByTagName("tbody");
        for (let i = 0; i < arrPengguna.length; i++) {
          let btnEdit = document.createElement("button");
          let btnHapus = document.createElement("button");
          if (sessionStorage.getItem("jenis_user") == "pemilik") {
            btnEdit.appendChild(document.createTextNode("edit"));
            btnEdit.className = "btn btn-primary btn-aksi btn-edit";
            btnEdit.onclick = function () {
              previewEdit(this);
            };
            btnHapus.appendChild(document.createTextNode("hapus"));
            btnHapus.className = "btn btn-danger btn-aksi btn-hapus";
            btnHapus.onclick = function () {
              previewHapus(this);
            };
          }
          let tr = document.createElement("tr");
          let td = document.createElement("td");
          td.textContent = i + 1;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrPengguna[i].nama;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrPengguna[i].jenis;
          tr.appendChild(td);
          td = document.createElement("td");
          if (arrPengguna[i].last_login == null) td.textContent = "-";
          else td.textContent = arrPengguna[i].last_login;
          tr.appendChild(td);
          td = document.createElement("td");
          if (sessionStorage.getItem("jenis_user") == "pemilik") {
            td.appendChild(btnEdit);
            td.appendChild(btnHapus);
          }
          tr.appendChild(td);
          tbody[0].appendChild(tr);
        }
        $(".btn-edit").attr("data-toggle", "modal");
        $(".btn-edit").attr("data-target", "#modalEditPengguna");
        $(".btn-hapus").attr("data-toggle", "modal");
        $(".btn-hapus").attr("data-target", "#modalHapusPengguna");
      }

      function insertPengguna() {
        if (
          $("#tambah-nama").val() == "" ||
          $("#tambah-username").val() == "" ||
          $("#tambah-password").val() == ""
        ) {
          dialogs.alert("Semua input nama harus diisi.");
        } else {
          let body = {
            nama: $("#tambah-nama").val(),
            id_jenis: $("#tambah-jenis").val(),
            username: $("#tambah-username").val(),
            password: $("#tambah-password").val(),
          };
          console.log(body);
          let url = baseUrl + "user/tambah";
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(body),
          })
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(data);
              if (data.status == 200) {
                sendAndroidNotif(data.message);
                insertNotif(data.message);
                dialogs.alert(data.message, (ok) => {
                  window.location = window.location;
                });
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      }

      function previewEdit(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPengguna[x].id;
        curId = id;
        $("#edit-nama").val(arrPengguna[x].nama);
        $("#edit-username").val(arrPengguna[x].username);
      }

      $("#edit-nama").keyup(function () {
        curEdit.nama = $("#edit-nama").val();
      });
      $("#edit-username").keyup(function () {
        curEdit.username = $("#edit-username").val();
      });
      $("#edit-password").keyup(function () {
        curEdit.password = $("#edit-password").val();
      });

      function insertEdit() {
        if (
          curEdit.nama == "" &&
          curEdit.username == "" &&
          curEdit.password == ""
        ) {
          dialogs.alert("Tidak ada yang diedit");
        } else {
          curEdit.id = curId;
          console.log(curEdit);
          let url = baseUrl + "user/edit";
          console.log(curEdit);
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(curEdit),
          })
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(data);
              if (data.status == 200) {
                sendAndroidNotif(data.message);
                insertNotif(data.message);
                dialogs.alert(data.message, (ok) => {
                  window.location = window.location;
                });
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      }

      function previewHapus(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPengguna[x].id;
        let nama = arrPengguna[x].nama;
        curId = id;
        $("#hapus-text").text(
          "Apakah Anda yakin ingin menghapus pengguna " + nama + "?"
        );
      }

      function hapusPengguna() {
        let body = {
          id: curId,
        };
        let url = baseUrl + "user/hapus";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(body),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            sendAndroidNotif(data.message);
            insertNotif(data.message);
            dialogs.alert(data.message, (ok) => {
              window.location = window.location;
            });
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal menghapus jenis produk.");
          });
      }

      function getAndroidToken() {
        // let url = "http://multirona.000webhostapp.com/index.php/android/token";
        let url = baseUrl + "android/token";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              arrToken.push(data[i].token);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function sendAndroidNotif(msg) {
        var myHeaders = new Headers();
        myHeaders.append("Content-type", "application/json");
        myHeaders.append(
          "Authorization",
          "key=AAAA50qCXc8:APA91bHjNNL3LH6gCsEVUy4qhO_2wU08w-MQw5zeqcKzNmWuzPXpaDVqfQRgv9B3FKDyEUAtC8RSoT4aWbovrbc5IYi_dzDkOiN-5BUi4wms5_GhJzAdr5piZ6q0mtEUOgvmI9dbJ21U"
        );

        var raw = JSON.stringify({
          registration_ids: arrToken,
          notification: {
            title: "Notif Multi Rona",
            body: msg,
          },
        });

        var requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("https://fcm.googleapis.com/fcm/send", requestOptions)
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.log("error", error));
      }

      //INSERT NOTIFIKASI
      function insertNotif(message) {
        let param = {
          message: message,
        };
        // let url = "http://multirona.000webhostapp.com/index.php/notifikasi";
        let url = baseUrl + "notifikasi";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
          })
          .catch((error) => console.log("error", error));
      }
    </script>
  </body>
</html>
