<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/reminder.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
  </head>
  <style>
    hr {
      border: 2px solid;
    }
  </style>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn" id="laporan-nav">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a class="active" href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a href="pengguna.html" style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Pelanggan</h2>
        <hr />
      </div>

      <div class="container">
        <h3>List Pelanggan</h3>
        <button
          class="btn btn-primary"
          style="float: right; margin-right: 10px; margin-bottom: 10px"
          data-toggle="modal"
          data-target="#modalTambahPelanggan"
          id="tambah-btn"
        >
          Tambah Pelanggan
        </button>

        <table style="text-align: center">
          <colgroup>
            <col span="1" style="width: 5%" />
            <col span="1" style="width: 20%" />
            <col span="1" style="width: 22%" />
            <col span="1" style="width: 23%" />
            <col span="1" style="width: 15%" />
            <col span="1" style="width: 15%" />
          </colgroup>
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Pelanggan</th>
              <th>No. Telp</th>
              <th>Alamat</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- MODAL TAMBAH PELANGGAN -->
      <div class="modal" id="modalTambahPelanggan">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Tambah Pelanggan</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 20%">
              <div class="row">
                <label for="nama">Nama Pelanggan : &emsp;</label>
                <input type="text" name="nama" id="tambah-nama" />
              </div>
              <br />
              <div class="row">
                <label for="alamat">Alamat &emsp;&emsp;&emsp; : &emsp;</label>
                <input
                  type="text"
                  name="alamat"
                  id="tambah-alamat"
                  style="width: 250px"
                />
              </div>
              <br />
              <div class="row">
                <label for="telp">No. Telp &emsp;&emsp;&emsp; : &emsp;</label>
                <input type="text" name="telp" id="tambah-telp" />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Batal
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="insertPelanggan()"
              >
                Tambah
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL EDIT PELANGGAN -->
      <div class="modal" id="modalEditPelanggan">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Edit Pelanggan</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 20%">
              <div class="row">
                <label for="nama">Nama &emsp;&emsp;&emsp;&ensp; : &emsp;</label>
                <input
                  type="text"
                  name="nama"
                  id="edit-nama"
                  style="width: 60%"
                />
              </div>
              <br />
              <div class="row">
                <label for="telp">No. Telp &emsp;&emsp;&emsp; : &emsp;</label>
                <input
                  type="text"
                  name="telp"
                  id="edit-telp"
                  style="width: 60%"
                />
              </div>
              <br />
              <div class="row">
                <label for="alamat">Alamat &emsp;&emsp;&emsp; : &emsp;</label>
                <input
                  type="text"
                  name="alamat"
                  id="edit-alamat"
                  style="width: 60%"
                />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Batal
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="insertEdit()"
              >
                Edit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL HAPUS PELANGGAN -->
      <div class="modal" id="modalHapusPelanggan">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Hapus Pelanggan</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body w3-display-container" style="padding: 5%">
              <p id="hapus-text"></p>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="button"
                class="btn btn-danger"
                data-dismiss="modal"
                onclick="hapusPelanggan()"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script>
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = sessionStorage.getItem("baseUrl");
      // var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // var baseUrl = "http://localhost/multi_rona/";
      // if (sessionStorage.getItem("online_db") == true)
      //   baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // else baseUrl = "http://localhost/multi_rona/";
      var arrPelanggan = [];
      var curId = "";
      var curEdit = {};
      var arrToken = [];
      window.onload = getPelanggan();
      window.onload = getAndroidToken();
      if (sessionStorage.getItem("jenis_user") != "pemilik") {
        $("#laporan-nav").css("display", "none");
        $("#tambah-btn").css("display","none");
      }

      function getPelanggan() {
        // let url = "http://multirona.000webhostapp.com/index.php/pelanggan";
        let url = baseUrl + "pelanggan";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrPelanggan = data;
            createTable();
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function createTable() {
        let tbody = document.getElementsByTagName("tbody");

        for (let i = 0; i < arrPelanggan.length; i++) {
          let btnEdit = document.createElement("button");
          btnEdit.appendChild(document.createTextNode("edit"));
          btnEdit.className = "btn btn-primary btn-aksi btn-edit";
          btnEdit.onclick = function () {
            previewEdit(this);
          };
          let btnHapus = document.createElement("button");
          btnHapus.appendChild(document.createTextNode("hapus"));
          btnHapus.className = "btn btn-danger btn-aksi btn-hapus";
          btnHapus.onclick = function () {
            previewHapus(this);
          };
          let tr = document.createElement("tr");

          let td = document.createElement("td");
          td.textContent = i + 1;
          tr.appendChild(td);

          td = document.createElement("td");
          td.textContent = arrPelanggan[i].nama;
          tr.appendChild(td);

          td = document.createElement("td");
          if (arrPelanggan[i].no_telp == null) td.textContent = "Tidak ada";
          else td.textContent = arrPelanggan[i].no_telp;
          tr.appendChild(td);

          td = document.createElement("td");
          if (arrPelanggan[i].alamat == null) td.textContent = "Tidak ada";
          else td.textContent = arrPelanggan[i].alamat;
          tr.appendChild(td);

          td = document.createElement("td");
          if (sessionStorage.getItem("jenis_user") == "pemilik") {
            td.appendChild(btnEdit);
            td.appendChild(btnHapus);
          }
          tr.appendChild(td);

          tbody[0].appendChild(tr);
        }
        $(".btn-edit").attr("data-toggle", "modal");
        $(".btn-edit").attr("data-target", "#modalEditPelanggan");
        $(".btn-hapus").attr("data-toggle", "modal");
        $(".btn-hapus").attr("data-target", "#modalHapusPelanggan");
      }

      function insertPelanggan() {
        if ($("#tambah-nama").val() == "") {
          dialogs.alert("Input nama harus diisi.");
        } else {
          let body = {
            nama: $("#tambah-nama").val(),
            no_telp: $("#tambah-telp").val(),
            alamat: $("#tambah-alamat").val(),
          };
          // let url = "http://multirona.000webhostapp.com/index.php/pelanggan";
          let url = baseUrl + "pelanggan";
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(body),
          })
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(data);
              if (data.status == 200) {
                sendAndroidNotif(data.message);
                insertNotif(data.message);
                dialogs.alert(data.message, (ok) => {
                  window.location = window.location;
                });
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      }

      function previewEdit(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPelanggan[x].id;
        curId = id;
        $("#edit-nama").val(arrPelanggan[x].nama);
        $("#edit-alamat").val(arrPelanggan[x].alamat);
        $("#edit-telp").val(arrPelanggan[x].no_telp);
      }

      $("#edit-nama").keyup(function () {
        curEdit.nama = $("#edit-nama").val();
        console.log(curEdit.nama);
      });
      $("#edit-keterangan").keyup(function () {
        curEdit.keterangan = $("#edit-keterangan").val();
      });
      $("#edit-alamat").keyup(function () {
        curEdit.alamat = $("#edit-alamat").val();
      });
      $("#edit-telp").keyup(function () {
        curEdit.telp = $("#edit-telp").val();
      });
      function insertEdit() {
        if (
          curEdit.nama == "" &&
          curEdit.keterangan == "" &&
          curEdit.alamat == "" &&
          curEdit.telp == ""
        ) {
          dialogs.alert("Tidak ada yang diedit");
        } else {
          curEdit.id = curId;
          console.log(curEdit);
          let body = {
            id: curId,
          };
          // let url =
          //   "http://multirona.000webhostapp.com/index.php/supplier/edit";
          let url = baseUrl + "pelanggan/edit";
          console.log(curEdit);
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(curEdit),
          })
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(data);
              if (data.status == 200) {
                sendAndroidNotif(data.message);
                insertNotif(data.message);
                dialogs.alert(data.message, (ok) => {
                  window.location = window.location;
                });
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      }

      function previewHapus(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrPelanggan[x].id;
        let nama = arrPelanggan[x].nama;
        curId = id;
        $("#hapus-text").text(
          "Apakah Anda yakin ingin menghapus pelanggan " + nama + "?"
        );
      }

      function hapusPelanggan() {
        let body = {
          id: curId,
        };
        // let url = "http://multirona.000webhostapp.com/index.php/supplier/hapus";
        let url = baseUrl + "pelanggan/hapus";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(body),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            sendAndroidNotif(data.message);
            insertNotif(data.message);
            dialogs.alert(data.message, (ok) => {
              window.location = window.location;
            });
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal menghapus jenis produk.");
          });
      }

      function getAndroidToken() {
        // let url = "http://multirona.000webhostapp.com/index.php/android/token";
        let url = baseUrl + "android/token";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              arrToken.push(data[i].token);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function sendAndroidNotif(msg) {
        var myHeaders = new Headers();
        myHeaders.append("Content-type", "application/json");
        myHeaders.append(
          "Authorization",
          "key=AAAA50qCXc8:APA91bHjNNL3LH6gCsEVUy4qhO_2wU08w-MQw5zeqcKzNmWuzPXpaDVqfQRgv9B3FKDyEUAtC8RSoT4aWbovrbc5IYi_dzDkOiN-5BUi4wms5_GhJzAdr5piZ6q0mtEUOgvmI9dbJ21U"
        );

        var raw = JSON.stringify({
          registration_ids: arrToken,
          notification: {
            title: "Notif Multi Rona",
            body: msg,
          },
        });

        var requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("https://fcm.googleapis.com/fcm/send", requestOptions)
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.log("error", error));
      }

      //INSERT NOTIFIKASI
      function insertNotif(message) {
        let param = {
          message: message,
        };
        // let url = "http://multirona.000webhostapp.com/index.php/notifikasi";
        let url = baseUrl + "notifikasi";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
          })
          .catch((error) => console.log("error", error));
      }
    </script>
  </body>
</html>
