<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/reminder.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
    <style>
      hr {
        border: 2px solid;
      }
      .inventaris-masuk label {
        margin-top: 10px;
      }
      .inventaris-masuk select,
      input {
        width: 250px;
        padding: 3px;
      }
      #form {
        margin-left: 5px;
      }
      #form input {
        margin-right: 5px;
        width: 15%;
      }
      table {
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="active dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a class="active" href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a href="pengguna.html" style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Inventaris</h2>
        <hr />
      </div>

      <div class="container inventaris-masuk">
        <h3>
          Edit Stok &emsp;<button class="btn btn-primary" onclick="refresh()">
            Refresh
          </button>
        </h3>
        <label for="barang"
          >Pilih Produk &emsp;&emsp;&emsp;&ensp; : &emsp;</label
        >
        <select name="produk" id="produk"></select
        ><br />
        <label for="satuan"
          >Satuan &emsp;&emsp;&emsp;&emsp;&emsp;&ensp; :&emsp;</label
        >
        <input type="text" name="satuan" id="satuan" disabled /><br />
        <label for="stok">Stok Sekarang&ensp;&emsp;&emsp;:&emsp;</label>
        <input type="number" name="stok" id="stok" disabled /><br />
        <label for="konversi">Jumlah Konversi &emsp;:&emsp;</label>
        <input type="number" name="konversi" id="konversi" disabled /><br />
        <label for="stok-edit">Ubah Stok Menjadi&ensp;:&emsp;</label>
        <input type="number" name="stok-edit" id="stok-edit" min="1" /><br />
        <label for="konversi-edit">Ubah Konversi &emsp;&emsp;:&emsp;</label>
        <input
          type="number"
          name="konversi-edit"
          id="konversi-edit"
          min="1"
        /><br />

        <!-- <hr /> -->
        <div id="form"></div>

        <label for="keterangan">Keterangan Edit&emsp;&ensp;:&emsp;</label>
        <input type="text" name="keterangan" id="keterangan" /><br />

        <div style="margin-top: 10px">
          <button
            class="btn btn-primary"
            onclick="preview()"
            data-toggle="modal"
            data-target="#myModal"
          >
            Edit
          </button>
        </div>
      </div>
    </div>

    <!-- The Modal -->
    <div class="modal" id="myModal">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Preview Edit Stok</h4>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>

          <!-- Modal body -->
          <div class="modal-body">
            <h5>Satuan Utama</h5>
            <div class="row">
              <div class="col">
                <p>Nama Produk &emsp;&emsp;:</p>
                <p>Satuan Produk &ensp;&emsp;:</p>
                <p>Stok Sekarang &ensp;&emsp;:</p>
                <p>Stok Konversi &ensp; &emsp; :</p>
                <p>Ubah Menjadi &emsp;&emsp;:</p>
                <p>Konversi Menjadi &nbsp;:</p>
                <p>Keterangan&emsp;&emsp;&emsp;:</p>
              </div>
              <div class="col-8">
                <p class="preview"></p>
                <p class="preview"></p>
                <p class="preview"></p>
                <p class="preview"></p>
                <input class="input-preview" disabled />
                <input class="input-preview" disabled />
                <input class="input-preview" disabled />
              </div>
            </div>
            <h5 id="ecer-judul" style="display: none">Satuan Eceran</h5>
            <table id="preview-tbl" style="display: none">
              <thead>
                <tr>
                  <th>Satuan Eceran</th>
                  <th>Stok Sekarang</th>
                  <th>Ubah Menjadi</th>
                </tr>
              </thead>
              <tbody id="preview-tbody"></tbody>
            </table>
          </div>

          <!-- Modal footer -->
          <div class="modal-footer">
            <h5>Apakah data ini sudah benar?</h5>
            <br />
            <button
              type="button"
              class="btn btn-danger"
              data-dismiss="modal"
              onclick="clearModal()"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              data-dismiss="modal"
              id="edit-btn"
              onclick="insertEdit()"
            >
              Edit
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script>
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // var baseUrl = "http://localhost/multi_rona/";
      // if (sessionStorage.getItem("online_db") == true)
      //   baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // else baseUrl = "http://localhost/multi_rona/";
      var arrProduk = [];
      var arrEcer = [];
      var arrIdxEcer = [];
      var arrSatuan = [];
      var arrSupplier = [];
      var is_eceran = false;
      var idSatuan = 0;
      var idxProduk = 0;
      var isEceran = false;
      var arrToken = [];
      window.onload = getProduk();
      window.onload = getAndroidToken();
      // window.onload = getSupplier();
      // console.log(sessionStorage.getItem("id_user"));

      dropdown = document.getElementsByClassName("dropdown-container");
      dropdown[0].addEventListener("click", function () {
        this.classList.toggle("active");
      });

      function getProduk() {
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/inventaris/pilih_produk";
        let url = baseUrl + "inventaris/pilih_produk";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrProduk = data;
            console.log(data);
            let select = document.getElementById("produk");
            for (let i = 0; i < data.length; i++) {
              let opt = document.createElement("option");
              opt.innerHTML = data[i].nama;
              opt.value = data[i].nama;
              select.appendChild(opt);
            }
            $("#konversi").val(data[0].jumlah_konversi);
            $("#konversi-edit").val(data[0].jumlah_konversi);
            idxProduk[data[0].id];
            getSatuan(data[0].id);
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function getSatuan(id) {
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/inventaris/satuan?id=" +
        //   id;
        let url = baseUrl + "inventaris/satuan?id=" + id;
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrSatuan = data;
            document.getElementById("satuan").value = data[0].nama_satuan;
            document.getElementById("stok").value = data[0].jumlah;
            idSatuan = data[0].id;
            is_eceran = false;
            if (data[0].is_eceran == 1) {
              arrEcer = data[0].ecer;
              is_eceran = true;
              listEcer();
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      document.getElementById("produk").oninput = function () {
        document.getElementById("stok").value = "";
        idxProduk = document.getElementById("produk").selectedIndex;
        const myNode = document.getElementById("form");
        while (myNode.firstChild) {
          myNode.removeChild(myNode.lastChild);
        }
        $("#konversi").val(arrProduk[idxProduk].jumlah_konversi);
        $("#konversi-edit").val(arrProduk[idxProduk].jumlah_konversi);
        getSatuan(arrProduk[idxProduk].id);
      };

      document.getElementById("stok-edit").oninput = function () {
        let konversiHasil =
          parseFloat($("#stok-edit").val()) *
          parseFloat(arrSatuan[0].konversi_satuan);
        $("#konversi-edit").val(konversiHasil);
      };

      function preview() {
        clearModal();
        let check = document.getElementsByClassName("list-check");
        let tbody = document.getElementById("preview-tbody");
        isEceran = false;
        for (let i = 0; i < check.length; i++) {
          if (check[i].checked == true) {
            let ubah = document.getElementsByClassName("list-ubah")[i].value;
            if (ubah == "") {
              dialogs.alert("Input Ubah Eceran tidak boleh kosong.");
            } else {
              isEceran = true;
              let tr = document.createElement("tr");
              let td = document.createElement("td");
              td.textContent = document.getElementsByClassName("list-satuan")[
                i
              ].value;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = document.getElementsByClassName("list-stok")[
                i
              ].value;
              tr.appendChild(td);
              td = document.createElement("td");
              td.textContent = document.getElementsByClassName("list-ubah")[
                i
              ].value;
              tr.appendChild(td);
              tbody.appendChild(tr);

              arrIdxEcer.push(i);
            }
          }
        }
        let preview = document.getElementsByClassName("preview");
        preview[0].innerHTML = document.getElementById("produk").value;
        preview[1].innerHTML = document.getElementById("satuan").value;
        preview[2].innerHTML = document.getElementById("stok").value;
        preview[3].innerHTML = document.getElementById("stok").value;
        let input = document.getElementsByClassName("input-preview");
        input[0].value = $("#stok-edit").val();
        input[1].value = $("#konversi-edit").val();
        input[2].value = $("#keterangan").val();
        if (isEceran) {
          if (keterangan == "") {
            dialogs.alert("Input Keterangan harus diisi!");
            document.getElementById("edit-btn").style.display = "none";
          } else {
            document.getElementById("preview-tbl").style.display = "block";
            document.getElementById("ecer-judul").style.display = "block";
            document.getElementById("edit-btn").style.display = "block";
          }
        } else if (edit == "") {
          dialogs.alert("Input jumlah stok harus diisi.");
          document.getElementById("edit-btn").style.display = "none";
        } else if (keterangan == "") {
          dialogs.alert("Input Keterangan harus diisi!");
          document.getElementById("edit-btn").style.display = "none";
        } else if (edit != "" && keterangan != "") {
          document.getElementById("edit-btn").style.display = "block";
        } else {
          document.getElementById("preview-tbl").style.display = "none";
          document.getElementById("ecer-judul").style.display = "none";
          document.getElementById("edit-btn").style.display = "none";
        }
      }

      function insertEdit() {
        let edit = document.getElementById("stok-edit").value;
        let tbody = document.getElementById("preview-tbody");
        let arrEdit = [];
        let param;
        if (isEceran) {
          let listCheck = document.getElementsByClassName("list-check");
          let listUbah = document.getElementsByClassName("list-ubah");
          console.log(listCheck[0].checked);
          console.log(listCheck[1].checked);
          console.log(listCheck[2].checked);
          for (let i = 0; i < listCheck.length; i++) {
            if (listCheck[i].checked) {
              let obj = {
                id: arrEcer[i].id_eceran,
                stok: arrEcer[i].jumlah_eceran,
                jumlah: listUbah[i].value,
                fk_satuan: arrEcer[i].id_satuan,
              };
              arrEdit.push(obj);
              console.log(arrEdit);
            }
          }
          arrIdxEcer = [];
          param = {
            fk_produk: arrProduk[idxProduk].id,
            stok: document.getElementById("stok").value,
            jumlah_konversi: document.getElementById("konversi-edit").value,
            jumlah_utama: edit,
            keterangan: document.getElementById("keterangan").value,
            fk_user: sessionStorage.getItem("id_user"),
            fk_satuan: idSatuan,
            arrEcer: arrEdit,
          };
        } else {
          param = {
            fk_produk: arrProduk[idxProduk].id,
            stok: document.getElementById("stok").value,
            jumlah_konversi: document.getElementById("konversi-edit").value,
            jumlah_utama: edit,
            keterangan: document.getElementById("keterangan").value,
            fk_user: sessionStorage.getItem("id_user"),
            fk_satuan: idSatuan,
            arrEcer: arrEdit,
          };
          console.log(param);
        }
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/inventaris/insert_edit/";
        let url = baseUrl + "inventaris/insert_edit/";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
            if (data.status == 200) {
              sendAndroidNotif(data.message);
              insertNotif(data.message);
              dialogs.alert(data.message, (ok) => {
                window.location = window.location;
              });
            }
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal mengedit transaksi!");
          });
      }

      function clearModal() {
        let preview = document.getElementsByClassName("preview");
        for (let i = 0; i < preview.length; i++) {
          preview[i].innerHTML = "";
        }
        let parent = document.getElementById("preview-tbody");
        while (parent.hasChildNodes()) {
          parent.removeChild(parent.firstChild);
        }
      }

      function refresh() {
        window.location = window.location;
      }

      function listEcer() {
        let br = document.createElement("br");
        let div = document.getElementById("form");
        let h5 = document.createElement("h5");
        let p = document.createElement("p");
        h5.innerHTML = "Edit Stok Eceran";
        p.innerHTML =
          "(Beri centang pada satuan eceran yang ingin diubah jumlah stoknya)";
        div.appendChild(br);
        div.appendChild(h5);
        div.appendChild(p);
        for (let i = 0; i < arrEcer.length; i++) {
          let check = document.createElement("input");
          check.className = "list-check";
          check.type = "checkbox";
          div.appendChild(check);
          let label = document.createElement("label");
          label.htmlFor = "edit-satuan-ecer";
          label.textContent = "Satuan Ecer : ";
          div.appendChild(label);
          let input = document.createElement("input");
          input.name = "edit-satuan-ecer";
          input.className = "list-satuan";
          input.value = arrEcer[i].nama_satuan;
          input.disabled = true;
          div.appendChild(input);

          label = document.createElement("label");
          label.htmlFor = "edit-jumlah-ecer";
          label.textContent = "Jumlah Ecer : ";
          div.appendChild(label);
          input = document.createElement("input");
          input.name = "edit-jumlah-ecer";
          input.className = "list-stok";
          input.value = arrEcer[i].jumlah_eceran;
          input.type = "number";
          input.disabled = true;
          div.appendChild(input);

          label = document.createElement("label");
          label.htmlFor = "edit-ubah-ecer";
          label.textContent = "Ubah Menjadi : ";
          div.appendChild(label);
          input = document.createElement("input");
          input.name = "edit-ubah-ecer";
          input.className = "list-ubah";
          input.type = "number";
          div.appendChild(input);
        }
      }

      function getAndroidToken() {
        // let url = "http://multirona.000webhostapp.com/index.php/android/token";
        let url = baseUrl + "android/token";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              arrToken.push(data[i].token);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function sendAndroidNotif(msg) {
        var myHeaders = new Headers();
        myHeaders.append("Content-type", "application/json");
        myHeaders.append(
          "Authorization",
          "key=AAAA50qCXc8:APA91bHjNNL3LH6gCsEVUy4qhO_2wU08w-MQw5zeqcKzNmWuzPXpaDVqfQRgv9B3FKDyEUAtC8RSoT4aWbovrbc5IYi_dzDkOiN-5BUi4wms5_GhJzAdr5piZ6q0mtEUOgvmI9dbJ21U"
        );

        var raw = JSON.stringify({
          // registration_ids: [
          //   "djH0PfyJSp-ozNO8ZapBpM:APA91bHDYwbLQeJqqQztctJiTAgnQUIAk7H8hMVXCaXbhNipUcWEhLJkHECxVpi71VByMZxWvhj8YCZcX7NJvmNNSW7qC5XjZ7Eu2TR_FGk2Z8WVCW6Dp0sJn2th8PBW6_Kb5hUj9xgz",
          // ],
          registration_ids: arrToken,
          notification: {
            title: "Notif Multi Rona",
            body: msg,
          },
        });

        var requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("https://fcm.googleapis.com/fcm/send", requestOptions)
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.log("error", error));
      }

      //INSERT NOTIFIKASI
      function insertNotif(message) {
        let param = {
          message: message,
        };
        // let url = "http://multirona.000webhostapp.com/index.php/notifikasi";
        let url = baseUrl + "notifikasi";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
          })
          .catch((error) => console.log("error", error));
      }

      function clearAll() {
        document.getElementById("produk").value = "";
        document.getElementById("satuan").value = "";
        document.getElementById("stok").value = "";
        document.getElementById("jumlah").value = "";
        document.getElementById("supplier").value = "";
      }
    </script>
  </body>
</html>
