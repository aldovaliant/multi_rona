<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Informasi Penjualan dan Inventaris Multirona</title>
    <link rel="stylesheet" href="css/w3.css" />
    <link rel="stylesheet" href="css/sidenav.css" />
    <link rel="stylesheet" href="css/reminder.css" />
    <link rel="stylesheet" href="../fonts/fontawesome/css/all.css" />
    <link
      rel="stylesheet"
      href="../bootstrap-4.1.3-dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/main.css" />
    <script>
      window.jQuery = window.$ = require("jquery");
    </script>
    <script src="js/popper.min.js"></script>
    <script src="../bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->

    <style>
      .btn-aksi {
        margin-left: 5px;
        margin-right: 5px;
      }
      hr {
        border: 2px solid;
      }
    </style>
  </head>
  <body>
    <div class="sidenav">
      <div class="sidebar-content">
        <div class="sidebar-item sidebar-header d-flex flex-nowrap">
          <div class="user-pic">
            <i class="fa fa-user w3-xxlarge"></i>
          </div>
          <div class="user-info">
            <span class="user-name"><strong>Setiadi</strong></span
            ><br />
            <span class="user-role">Owner</span>
          </div>
        </div>
      </div>
      <hr />
      <h1>Menu</h1>
      <a href="dashboard.html"
        ><i class="fa fa-home w3-xlarge"></i> Dashboard</a
      >
      <a href="penjualan.html"
        ><i class="fa fa-shopping-bag w3-xlarge"></i> Penjualan</a
      >
      <button class="dropdown-btn">
        <i class="fas fa-list-ul w3-xlarge"></i>
        Inventaris
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="inventaris_stok.html"
          ><i class="fas fa-circle w3-small"></i> Stok Produk</a
        >
        <a href="inventaris_masuk.html"
          ><i class="fas fa-circle w3-small"></i> Tambah Stok</a
        >
        <a href="inventaris_edit.html"
          ><i class="fas fa-circle w3-small"></i> Edit Stok</a
        >
        <a href="peralatan.html"
          ><i class="fas fa-circle w3-small"></i> Peralatan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Data Produk
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="data_produk_list.html"
          ><i class="fas fa-circle w3-small"></i> List Produk</a
        >
        <a class="active" href="data_produk_jenis.html"
          ><i class="fas fa-circle w3-small"></i> Jenis Produk</a
        >
        <a href="data_produk_satuan.html"
          ><i class="fas fa-circle w3-small"></i> Satuan</a
        >
      </div>
      <button class="dropdown-btn">
        <i class="fas fa-folder-open w3-xlarge"></i>
        Laporan
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-container">
        <a href="laporan_penjualan.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Penjualan</a
        >
        <a href="laporan_stok.html"
          ><i class="fas fa-circle w3-small"></i> Laporan Stok Produk</a
        >
      </div>
      <a href="supplier.html"
        ><i class="fab fa-dropbox w3-xlarge"></i> Supplier</a
      >
      <a href="pelanggan.html"
        ><i class="fas fa-user w3-xlarge"></i> Pelanggan</a
      >
      <a href="pengguna.html" style="bottom: 6%; position: absolute"
        ><i class="fa fa-user-circle w3-xlarge"></i> Pengguna</a
      >
      <a href="login.html" style="bottom: 0; position: absolute"
        ><i class="fa fa-sign-out-alt w3-xlarge"></i> Keluar</a
      >
    </div>

    <div class="main">
      <div class="container" id="judul">
        <h2>Data Produk</h2>
        <hr />
      </div>

      <div class="container">
        <h3>Jenis Produk</h3>

        <button
          class="btn btn-primary"
          style="float: right; margin-right: 10px; margin-bottom: 10px"
          data-toggle="modal"
          data-target="#modalTambahJenis"
        >
          Tambah Jenis
        </button>

        <table style="text-align: center">
          <colgroup>
            <col span="1" style="width: 10%" />
            <col span="1" style="width: 30%" />
            <col span="1" style="width: 40%" />
            <col span="1" style="width: 20%" />
          </colgroup>
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Jenis</th>
              <th>Keterangan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- MODAL TAMBAH JENIS -->
      <div class="modal" id="modalTambahJenis">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Tambah Jenis</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 25%">
              <div class="row">
                <label for="nama">Nama Jenis : &emsp;</label>
                <input type="text" name="nama" id="tambah-nama" />
              </div>
              <br />
              <div class="row">
                <label for="keterangan">Keterangan : &emsp;</label>
                <input type="text" name="keterangan" id="tambah-keterangan" />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Close
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="checkInput('tambah')"
              >
                Tambah
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL EDIT JENIS -->
      <div class="modal" id="modalEditJenis">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Form Edit Jenis</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="margin-left: 25%">
              <div class="row">
                <label for="nama">Nama Jenis : &emsp;</label>
                <input type="text" name="nama" id="edit-nama" />
              </div>
              <br />
              <div class="row">
                <label for="keterangan">Keterangan : &emsp;</label>
                <input type="text" name="keterangan" id="edit-keterangan" />
              </div>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Batal
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-dismiss="modal"
                onclick="checkInput('edit')"
              >
                Edit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL HAPUS JENIS -->
      <div class="modal" id="modalHapusJenis">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Hapus Jenis Produk</h4>
              <button type="button" class="close" data-dismiss="modal">
                &times;
              </button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
              <p id="hapus-nama"></p>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="button"
                class="btn btn-danger"
                data-dismiss="modal"
                onclick="hapusJenis()"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/side_nav.js"></script>
    <script type="text/javascript">
      const Dialogs = require("dialogs");
      const dialogs = Dialogs();
      var baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // var baseUrl = "http://localhost/multi_rona/";
      // if (sessionStorage.getItem("online_db") == true)
      //   baseUrl = "http://multirona.000webhostapp.com/index.php/";
      // else baseUrl = "http://localhost/multi_rona/";
      var arrJenis = [];
      var curId;
      var arrToken = [];
      window.onload = getJenis();
      window.onload = getAndroidToken();

      function getJenis() {
        let dropdown = document.getElementsByClassName("dropdown-btn");
        dropdown[0].addEventListener("click", function () {
          this.classList.toggle("active");
        });

        // let url = "http://multirona.000webhostapp.com/index.php/produk/jenis";
        let url = baseUrl + "produk/jenis";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            arrJenis = data;
            createTable();
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function createTable() {
        let tbl = document.createElement("table");
        let thead = document.createElement("thead");
        let tbody = document.getElementsByTagName("tbody");

        for (let i = 0; i < arrJenis.length; i++) {
          // let btnDetail = document.createElement("button");
          // btnDetail.appendChild(document.createTextNode("detail"));
          // btnDetail.className = "btn btn-secondary btn-aksi";
          let btnEdit = document.createElement("button");
          btnEdit.appendChild(document.createTextNode("edit"));
          btnEdit.className = "btn btn-primary btn-aksi btn-edit";
          btnEdit.onclick = function () {
            previewEdit(this);
          };
          let btnHapus = document.createElement("button");
          btnHapus.appendChild(document.createTextNode("hapus"));
          btnHapus.className = "btn btn-danger btn-aksi btn-hapus";
          btnHapus.onclick = function () {
            previewHapus(this);
          };

          let tr = document.createElement("tr");
          let td = document.createElement("td");
          td.textContent = i + 1;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrJenis[i].nama;
          tr.appendChild(td);
          td = document.createElement("td");
          td.textContent = arrJenis[i].keterangan;
          tr.appendChild(td);
          td = document.createElement("td");
          // td.appendChild(btnDetail);
          td.appendChild(btnEdit);
          td.appendChild(btnHapus);
          tr.appendChild(td);

          tbody[0].appendChild(tr);
        }
        $(".btn-edit").attr("data-toggle", "modal");
        $(".btn-edit").attr("data-target", "#modalEditJenis");
        $(".btn-hapus").attr("data-toggle", "modal");
        $(".btn-hapus").attr("data-target", "#modalHapusJenis");
      }

      function checkInput(param) {
        let link;
        if (
          $("#" + param + "-nama").val() == "" ||
          $("#" + param + "-keterangan").val() == ""
        ) {
          dialogs.alert("Input harus diisi dengan lengkap.");
        } else {
          let body = {
            id: curId,
            nama: $("#" + param + "-nama").val(),
            keterangan: $("#" + param + "-keterangan").val(),
          };
          // let url =
          //   "http://multirona.000webhostapp.com/index.php/produk/" +
          //   param +
          //   "_jenis";
          let url = baseUrl + "produk/" + param + "_jenis";
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(body),
          })
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(data);
              if (data.status == 200) {
                sendAndroidNotif(data.message);
                insertNotif(data.message);
                dialogs.alert(data.message, (ok) => {
                  window.location = window.location;
                });
              }
            })
            .catch(function (error) {
              console.log(error);
            });
          curId = null;
        }
      }

      function previewEdit(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrJenis[x].id;
        curId = id;
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/produk/jenis?id=" + id;
        let url = baseUrl + "produk/jenis?id=" + id;
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            $("#edit-nama").val(data[0].nama);
            $("#edit-keterangan").val(data[0].keterangan);
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal mengedit jenis produk.");
          });
      }

      function previewHapus(param) {
        let x = param.parentNode.parentNode.rowIndex - 1;
        let id = arrJenis[x].id;
        let nama = arrJenis[x].nama;
        curId = id;
        $("#hapus-nama").text(
          "Apakah anda yakin ingin menghapus jenis " + arrJenis[x].nama + "?"
        );
      }

      function hapusJenis() {
        let body = {
          id: curId,
        };
        // let url =
        //   "http://multirona.000webhostapp.com/index.php/produk/hapus_jenis";
        let url = baseUrl + "produk/hapus_jenis";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(body),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            if (data.status == 200) {
              sendAndroidNotif(data.message);
              insertNotif(data.message);
              dialogs.alert(data.message, (ok) => {
                window.location = window.location;
              });
            }
          })
          .catch(function (error) {
            console.log(error);
            dialogs.alert("Gagal menghapus jenis produk.");
          });
      }

      function getAndroidToken() {
        // let url = "http://multirona.000webhostapp.com/index.php/android/token";
        let url = baseUrl + "android/token";
        fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              arrToken.push(data[i].token);
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function sendAndroidNotif(msg) {
        var myHeaders = new Headers();
        myHeaders.append("Content-type", "application/json");
        myHeaders.append(
          "Authorization",
          "key=AAAA50qCXc8:APA91bHjNNL3LH6gCsEVUy4qhO_2wU08w-MQw5zeqcKzNmWuzPXpaDVqfQRgv9B3FKDyEUAtC8RSoT4aWbovrbc5IYi_dzDkOiN-5BUi4wms5_GhJzAdr5piZ6q0mtEUOgvmI9dbJ21U"
        );

        var raw = JSON.stringify({
          // registration_ids: [
          //   "djH0PfyJSp-ozNO8ZapBpM:APA91bHDYwbLQeJqqQztctJiTAgnQUIAk7H8hMVXCaXbhNipUcWEhLJkHECxVpi71VByMZxWvhj8YCZcX7NJvmNNSW7qC5XjZ7Eu2TR_FGk2Z8WVCW6Dp0sJn2th8PBW6_Kb5hUj9xgz",
          // ],
          registration_ids: arrToken,
          notification: {
            title: "Notif Multi Rona",
            body: msg,
          },
        });

        var requestOptions = {
          method: "POST",
          headers: myHeaders,
          body: raw,
          redirect: "follow",
        };

        fetch("https://fcm.googleapis.com/fcm/send", requestOptions)
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.log("error", error));
      }

      //INSERT NOTIFIKASI
      function insertNotif(message) {
        let param = {
          message: message,
        };
        // let url = "http://multirona.000webhostapp.com/index.php/notifikasi";
        let url = baseUrl + "notifikasi";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(param),
        })
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(data);
          })
          .catch((error) => console.log("error", error));
      }
    </script>
  </body>
</html>
